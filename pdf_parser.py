import pandas as pd
import pdfplumber
import re
from io import BytesIO

# Lookup table για την περιγραφή αποδοχών
APODOXES_DESCRIPTIONS = {
    '01': 'Τακτικές αποδοχές', '02': 'Αποδοχές υπαλλήλων ΝΠΔΔ κλπ.', '03': 'Δώρο Χριστουγέννων',
    '04': 'Δώρο Πάσχα', '05': 'Επίδομα αδείας', '06': 'Επίδομα ισολογισμού',
    '07': 'Αποδοχές αδειών εποχικά απασχ/νων Ξενοδ/λων', '08': 'Αποδοχές ασθενείας',
    '09': 'Αναδρομικές αποδοχές', '10': 'Bonus', '11': 'Υπερωρίες', '12': 'Αμοιβή με το κομμάτι (Φασόν)',
    '13': 'Τεκμαρτές Αποδοχές', '14': 'Λοιπές Αποδοχές', '15': 'Τεκμαρτές Αποδοχές για κλάδο ΕΤΕΑΜ',
    '16': 'Αμοιβές κατ\' αποκοπήν/ΕΦΑΠΑΞ', '17': 'Εισφορές χωρίς αποδοχές',
    '18': 'Κανονικές αποδοχές πληρ/των Μεσογ τουρ πλοίων',
    '19': 'Αποδοχές αδείας πληρωμάτων Μεσογ τουρ πλοίων', '20': 'Αποδοχές Ασφαλιζομένων στο ΕΤΕΑΜ',
    '21': 'Τακτικές αποδοχές', '22': 'Δώρο Χριστουγέννων', '23': 'Δώρο Πάσχα', '24': 'Επίδομα Αδείας',
    '25': 'Επίδομα Ισολογισμού', '26': 'Αποδοχές Ασθενείας', '27': 'Αναδρομικές αποδοχές',
    '28': 'Bonus', '29': 'Υπερωρίες', '30': 'Λοιπές αποδοχές', '31': 'Εισφορές χωρίς αποδοχές',
    '32': 'Τακτικές Αποδοχές – Δ.Π.Υ.', '33': 'Δώρο Πάσχα – Δ.Π.Υ.', '34': 'Επίδομα Αδείας – Δ.Π.Υ.',
    '35': 'Δώρο Χριστουγέννων – Δ.Π.Υ.',
    '36': 'Τακτικές αποδοχές για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '37': 'Δώρο Πάσχα για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '38': 'Δώρο Χριστουγέννων για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '39': 'Επίδομα Αδείας για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '40': 'Επίδομα Ισολογισμού για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '41': 'Υπερωρίες για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '42': 'Αναδρομικές αποδοχές για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '43': 'Bonus για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '44': 'Τακτικές αποδοχές για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '45': 'Δώρο Χριστουγέννων για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '46': 'Δώρο Πάσχα για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '47': 'Επίδομα Αδείας για υπολογισμό συνεισπραττόμενων εισφορών και ΕΤΕΑΜ',
    '48': 'Αναδρομικές αποδοχές για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '49': 'Bonus για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '50': 'Αποδοχές αδειών εποχικών απασχολουμένων για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '51': 'Λοιπές αποδοχές για υπολογισμό εισφορών υπέρ Ειδικού Λογαριασμού Ξενοδοχοϋπαλλήλων',
    '52': 'Τακτικές αποδοχές για υπολογισμό εισφορών ασθένειας σε είδος και σε χρήμα τ. ΤΑΞΥ',
    '53': 'Δώρο Πάσχα για υπολογισμό εισφορών ασθένειας σε είδος και σε χρήμα τ. ΤΑΞΥ',
    '54': 'Δώρο Χριστουγέννων για υπολογισμό εισφορών ασθένειας σε είδος και σε χρήμα τ. ΤΑΞΥ',
    '55': 'Επίδομα Αδείας για υπολογισμό εισφορών ασθένειας σε είδος και σε χρήμα τ. ΤΑΞΥ',
    '56': 'Τακτικές αποδοχές', '57': 'Δώρο Χριστουγέννων', '58': 'Δώρο Πάσχα', '59': 'Επίδομα Αδείας',
    '60': 'Επίδομα Ισολογισμού', '61': 'Αποδοχές Ασθενείας', '62': 'Αναδρομικές αποδοχές',
    '63': 'Bonus', '64': 'Υπερωρίες', '65': 'Λοιπές αποδοχές', '66': 'Εισφορές χωρίς αποδοχές',
    '67': 'Τακτικές αποδοχές για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '68': 'Δώρο Χριστουγέννων για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '69': 'Δώρο Πάσχα για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '70': 'Επίδομα Αδείας για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '71': 'Επίδομα Ισολογισμού για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '72': 'Αποδοχές Ασθενείας για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '73': 'Αναδρομικές αποδοχές για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '74': 'Bonus για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '75': 'Υπερωρίες για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '76': 'Λοιπές αποδοχές για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '77': 'Εισφορές χωρίς αποδοχές για υπολογισμό εισφορών υπέρ ΙΚΑ – ΕΤΕΑΜ',
    '78': 'Τακτικές Αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '79': 'Δώρο Χριστουγέννων για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '80': 'Δώρο Πάσχα για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '81': 'Επίδομα αδείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '82': 'Επίδομα Ισολογισμού για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '83': 'Αποδοχές ασθενείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '84': 'Αναδρομικές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '85': 'Bonus για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '86': 'Υπερωρίες για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '87': 'Λοιπές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '88': 'Εισφορές χωρίς αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/07 – 31/7/2012',
    '89': 'Τακτικές Αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '90': 'Δώρο Χριστουγέννων για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '91': 'Δώρο Πάσχα για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '92': 'Επίδομα αδείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '93': 'Επίδομα Ισολογισμού για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '94': 'Αποδοχές ασθενείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '95': 'Αναδρομικές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '96': 'Bonus για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '97': 'Υπερωρίες για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '98': 'Λοιπές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '99': 'Εισφορές χωρίς αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/12 – 31/7/2017',
    '100': 'Τακτικές Αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '101': 'Δώρο Χριστουγέννων για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '102': 'Δώρο Πάσχα για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '103': 'Επίδομα αδείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '104': 'Επίδομα Ισολογισμού για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '105': 'Αποδοχές ασθενείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '106': 'Αναδρομικές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '107': 'Bonus για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '108': 'Υπερωρίες για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '109': 'Λοιπές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '110': 'Εισφορές χωρίς αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/17 – 31/7/2022',
    '111': 'Τακτικές Αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '112': 'Δώρο Χριστουγέννων για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '113': 'Δώρο Πάσχα για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '114': 'Επίδομα αδείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '115': 'Επίδομα Ισολογισμού για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '116': 'Αποδοχές ασθενείας για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '117': 'Αναδρομικές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '118': 'Bonus για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '119': 'Υπερωρίες για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '120': 'Λοιπές αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
    '121': 'Εισφορές χωρίς αποδοχές για υπολογισμό εισφορών κλάδου κύριας σύνταξης τ. Τ.Σ.Ε.Α.Π.Γ.Σ.Ο. από 1/8/22',
}

def clean_numeric_value(value):
    """Μετατρέπει μια τιμή string σε float, χειρίζοντας το ελληνικό format."""
    if value is None or value == '':
        return 0.0
    # Αφαιρούμε το σύμβολο του ευρώ και τις τελείες χιλιάδων, αντικαθιστούμε το κόμμα με τελεία
    cleaned_value = str(value).replace('€', '').replace('.', '').replace(',', '.').strip()
    try:
        return float(cleaned_value)
    except (ValueError, TypeError):
        return 0.0

def smart_summary_row_mapping(row):
    """
    Έξυπνη επεξεργασία γραμμής συνοπτικών δεδομένων με κανόνες mapping ανά στήλη.
    Χρησιμοποιεί patterns για να βρει τα δεδομένα στις σωστές στήλες.
    """
    if not row or len(row) < 3:
        return None
    
    cleaned_row = [str(cell).strip() if cell else '' for cell in row]
    
    processed_row = [''] * 7
    
    earnings_pattern = re.compile(r'^\d{1,3}(\.\d{3})*,\d{2}$')
    days_pattern = re.compile(r'^\d{1,3}$')
    year_pattern = re.compile(r'^\d{4}$')
    package_pattern = re.compile(r'^\d+$')
    
    if len(cleaned_row) >= 2:
        if year_pattern.match(cleaned_row[0]):
            processed_row[0] = cleaned_row[0]
        else:
            return None
        
        if package_pattern.match(cleaned_row[1]):
            processed_row[1] = cleaned_row[1]
        else:
            return None
    
    description_parts = []
    earnings_found = False
    days_worked_found = False
    days_insured_found = False
    
    for i, cell in enumerate(cleaned_row[2:], 2):
        if not cell:
            continue
        
        if "ΟΡΙΣΤΙΚΟΠΟΙΗΜΕΝΕΣ" in cell:
            processed_row[6] = "ΟΡΙΣΤΙΚΟΠΟΙΗΜΕΝΕΣ"
            continue
        
        if cell == "ΟΡ":
            if not processed_row[6]:
                processed_row[6] = "ΟΡ"
            continue
        
        if not earnings_found and earnings_pattern.match(cell):
            processed_row[3] = cell
            earnings_found = True
            continue
        
        if earnings_found and not days_worked_found and days_pattern.match(cell):
            processed_row[4] = cell
            days_worked_found = True
            continue
        
        if days_worked_found and not days_insured_found and days_pattern.match(cell):
            processed_row[5] = cell
            days_insured_found = True
            continue
        
        if not earnings_found:
            description_parts.append(cell)
    
    processed_row[2] = ' '.join(description_parts).strip()
    
    if not processed_row[6] and "ΟΡΙΣΤΙΚΟΠΟΙΗΜΕΝΕΣ" in processed_row[2]:
        processed_row[6] = "ΟΡΙΣΤΙΚΟΠΟΙΗΜΕΝΕΣ"
        processed_row[2] = processed_row[2].replace("ΟΡΙΣΤΙΚΟΠΟΙΗΜΕΝΕΣ", "").strip()
    
    if processed_row[0] and processed_row[1] and processed_row[2]:
        return processed_row
    else:
        return None

def normalize_detailed_row(row):
    """
    Κανονικοποιεί γραμμή αναλυτικών δεδομένων με κανόνες:
    - ΠΕΡΙΟΔΟΣ: MM/YYYY (>= 01/2002)
    - ΤΥΠΟΣ ΑΠΟΔΟΧΩΝ: 2-ψήφιος κωδικός από το lookup
    - ΑΠΟΔΟΧΕΣ/ΕΙΣΦΟΡΕΣ: ποσά σε ελληνικό format
    Εντοπίζει δυναμικά τη θέση των πεδίων και διορθώνει μετατοπίσεις.
    """
    if not row:
        return None

    def is_period(value):
        return bool(re.match(r"^\d{2}/\d{4}$", str(value).strip()))

    def is_days(value):
        return bool(re.match(r"^\d{1,2}$", str(value).strip()))

    def is_type_code(value):
        return str(value).strip() in APODOXES_DESCRIPTIONS

    def is_amount(value):
        return bool(re.match(r"^\d{1,3}(\.\d{3})*,\d{2}$", str(value).strip()))

    row_values = [str(cell).strip() if cell is not None else "" for cell in row]

    # Βασική επικύρωση περιόδου
    if not is_period(row_values[0]):
        return None

    # Εντοπισμός ΤΥΠΟΣ ΑΠΟΔΟΧΩΝ μετά τις ΗΜΕΡ. ΑΠΑΣΧ.
    type_idx = None
    for idx in range(6, len(row_values)):
        if is_type_code(row_values[idx]):
            type_idx = idx
            break

    if type_idx is None:
        return row_values

    # Εντοπισμός ΑΠΟΔΟΧΕΣ και ΕΙΣΦΟΡΕΣ μετά τον τύπο
    apodoxes_idx = None
    eisfores_idx = None
    for idx in range(type_idx + 1, len(row_values)):
        if apodoxes_idx is None and is_amount(row_values[idx]):
            apodoxes_idx = idx
            continue
        if apodoxes_idx is not None and is_amount(row_values[idx]):
            eisfores_idx = idx
            break

    # Αν δεν βρέθηκαν ποσά, επιστρέφουμε όπως είναι
    if apodoxes_idx is None:
        return row_values

    # Σύνθεση κανονικοποιημένης γραμμής
    return [
        row_values[0],  # ΠΕΡΙΟΔΟΣ
        row_values[1] if len(row_values) > 1 else "",  # ΚΩΔ. ΚΑΔ
        row_values[2] if len(row_values) > 2 else "",  # ΚΩΔ. ΕΙΔΙΚ.
        row_values[3] if len(row_values) > 3 else "",  # ΚΩΔΙΚΟΣ ΕΙΔΙΚΗΣ ΠΕΡΙΠΤΩΣΗΣ
        row_values[4] if len(row_values) > 4 else "",  # ΚΩΔ. ΠΑΚΕΤΟ ΚΑΛΥΨΗΣ
        row_values[5] if len(row_values) > 5 and is_days(row_values[5]) else "",  # ΗΜΕΡ. ΑΠΑΣΧ.
        row_values[type_idx],  # ΤΥΠΟΣ ΑΠΟΔΟΧΩΝ
        row_values[apodoxes_idx],  # ΑΠΟΔΟΧΕΣ
        row_values[eisfores_idx] if eisfores_idx is not None else "",  # ΕΙΣΦΟΡΕΣ
    ]

def parse_efka_pdf(file_bytes):
    """
    Αναλύει το PDF αρχείο του e-EFKA και εξάγει τα δεδομένα σε δύο DataFrames.
    """
    monthly_data = []
    annual_data = []

    table_settings = {
        "vertical_strategy": "text",
        "horizontal_strategy": "text",
    }

    date_pattern = re.compile(r"^\d{2}/\d{4}$")
    date_pattern_alt1 = re.compile(r"^\d{2}/\d{4}$")  # Same as main pattern
    date_pattern_alt2 = re.compile(r"^\d{1,2}/\d{4}$")  # Allow single digit month
    year_pattern = re.compile(r"^\d{4}$")

    with pdfplumber.open(BytesIO(file_bytes)) as pdf:
        for page in pdf.pages:
            tables = page.extract_tables(table_settings)
            for table in tables:
                for row_idx, row in enumerate(table):
                    if not row:
                        continue
                    
                    # Αναγνώριση μηνιαίων δεδομένων (π.χ., "01/2002")
                    if row[0] and date_pattern.match(str(row[0])):
                        monthly_data.append(row)
                    elif row[0] and date_pattern_alt1.match(str(row[0])):
                        monthly_data.append(row)
                    elif row[0] and date_pattern_alt2.match(str(row[0])):
                        monthly_data.append(row)
                    # Έλεγχος για shifted detailed data σε non-empty columns
                    elif row and len(row) > 0:
                        non_empty_cols = [i for i, cell in enumerate(row) if cell and str(cell).strip()]
                        if non_empty_cols and date_pattern.match(str(row[non_empty_cols[0]])):
                            monthly_data.append(row)
                        elif non_empty_cols and date_pattern_alt1.match(str(row[non_empty_cols[0]])):
                            monthly_data.append(row)
                        elif non_empty_cols and date_pattern_alt2.match(str(row[non_empty_cols[0]])):
                            monthly_data.append(row)
                    
                    # Αναγνώριση ετήσιων δεδομένων (π.χ., "2002") - skip header row
                    if row_idx > 0 and row and row[0] and year_pattern.match(str(row[0])):
                        # Εδώ χειριζόμαστε και την περίπτωση που μια γραμμή ετήσιων δεδομένων
                        # είναι σπασμένη σε δύο γραμμές στο PDF
                        if len(row) > 1 and row[1] is not None and '\n' in str(row[1]):
                            parts = str(row[1]).split('\n')
                            if len(parts) == 2 and len(row) > 2:
                                # Δημιουργούμε δύο νέες γραμμές από τη μία
                                annual_data.append([row[0], parts[0]] + row[2:])
                                annual_data.append([row[0], parts[1]] + [None] * (len(row) - 2))
                            else:
                                annual_data.append(row)
                        else:
                            annual_data.append(row)


    # Δημιουργία DataFrame για τα αναλυτικά μηνιαία δεδομένα
    # Χρησιμοποιούμε 9 βασικές στήλες όπως στην παλιότερη εφαρμογή
    monthly_columns = [
        'ΠΕΡΙΟΔΟΣ', 'ΚΩΔ. ΚΑΔ', 'ΚΩΔ. ΕΙΔΙΚ.', 'ΚΩΔΙΚΟΣ ΕΙΔΙΚΗΣ ΠΕΡΙΠΤΩΣΗΣ',
        'ΚΩΔ. ΠΑΚΕΤΟ ΚΑΛΥΨΗΣ', 'ΗΜΕΡ. ΑΠΑΣΧ.', 'ΤΥΠΟΣ ΑΠΟΔΟΧΩΝ', 'ΑΠΟΔΟΧΕΣ',
        'ΕΙΣΦΟΡΕΣ'
    ]

    # Προσαρμόζουμε τα δεδομένα στις 9 στήλες
    processed_monthly = []
    for row in monthly_data:
        processed_row = normalize_detailed_row(row)
        if processed_row is None:
            continue
        # Παίρνουμε τις πρώτες 9 στήλες μετά την κανονικοποίηση
        processed_row = processed_row[:9]
        
        # Προσαρμόζουμε στον αριθμό των στηλών που περιμένουμε
        if len(processed_row) < len(monthly_columns):
            processed_monthly.append(processed_row + [None] * (len(monthly_columns) - len(processed_row)))
        else:
            processed_monthly.append(processed_row[:len(monthly_columns)])


    df_monthly = pd.DataFrame(processed_monthly, columns=monthly_columns)


    # Δημιουργία DataFrame για τα συνοπτικά ετήσια δεδομένα
    annual_columns = [
        'ΕΤΟΣ', 'ΠΑΚ. ΚΑΛ.', 'ΠΕΡΙΓΡΑΦΗ', 'ΑΠΟΔΟΧΕΣ',
        'ΗΜΕΡ. ΑΠΑΣΧ.', 'ΗΜΕΡ. ΠΡΟΣ.', 'ΚΑΤΑΣΤΑΣΗ'
    ]
    # Χρησιμοποιούμε την έξυπνη αντιστοίχιση για να βρούμε τα δεδομένα στις σωστές στήλες
    processed_annual = []
    for row in annual_data:
        mapped_row = smart_summary_row_mapping(row)
        if mapped_row:
            processed_annual.append(mapped_row)

    if processed_annual:
        df_annual = pd.DataFrame(processed_annual, columns=annual_columns)
    else:
        df_annual = pd.DataFrame(columns=annual_columns)

    # Καθαρισμός δεδομένων
    if not df_monthly.empty:
        df_monthly['ΑΠΟΔΟΧΕΣ'] = df_monthly['ΑΠΟΔΟΧΕΣ'].apply(clean_numeric_value)
        df_monthly['ΕΙΣΦΟΡΕΣ'] = df_monthly['ΕΙΣΦΟΡΕΣ'].apply(clean_numeric_value)
        df_monthly['ΗΜΕΡ. ΑΠΑΣΧ.'] = pd.to_numeric(df_monthly['ΗΜΕΡ. ΑΠΑΣΧ.'], errors='coerce').fillna(0).astype(int)
        df_monthly['ΠΕΡΙΓΡΑΦΗ_ΑΠΟΔΟΧΩΝ'] = df_monthly['ΤΥΠΟΣ ΑΠΟΔΟΧΩΝ'].map(APODOXES_DESCRIPTIONS).fillna('Άγνωστος Κωδικός')

    if not df_annual.empty:
        df_annual['ΑΠΟΔΟΧΕΣ'] = df_annual['ΑΠΟΔΟΧΕΣ'].apply(clean_numeric_value)
        df_annual['ΗΜΕΡ. ΑΠΑΣΧ.'] = pd.to_numeric(df_annual['ΗΜΕΡ. ΑΠΑΣΧ.'], errors='coerce').fillna(0).astype(int)

    return df_monthly, df_annual

